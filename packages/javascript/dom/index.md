---
title: 页面构建过程
order: 1
---

## 前言

典型客户端 Web 应用的生命周期从用户在浏览器地址栏输入一串 URL，或单击一个链接开始。例如，我们在浏览器中输入了 URL，www.google.com

1. 浏览器构建了发送至服务器的请求
2. 服务器处理了请求并形成了一个通常由 HTML、CSS 和 JavaScript 代码所组成的响应。
3. 当浏览器接收了响应时，我们的客户端应用开始了它的生命周期。

## 页面构建阶段

当 Web 应用能被展示或交互之前，其页面必须根据服务器获取的响应（通常是 HTML、CSS 和 JavaScript 代码）来构建。
页面构建阶段的目标是建立 Web 应用的 UI，其主要包括两个步骤：

1. 解析 HTML 代码并构建文档对象模型（DOM）；
2. 执行 JavaScript 代码。

只要还有没处理完的 HTML 元素和没执行完的 JavaScript 代码，上面两个步骤都会一直交替执行。

### HTML 解析和 DOM 构建

页面构建阶段始于浏览器接收 HTML 代码时，该阶段为浏览器构建页面 UI 的基础。通过解析收到的 HTML 代码，构建一个个 HTML 元素，
构建 DOM。在这种对 HTML 结构化表示的形式中，每个 HTML 元素都被当作一个节点。直到遇到第一个脚本元素，页面都在构建 DOM。

为了正确构建每个 DOM，浏览器还会修复它在蓝图中发现的问题。

在页面构建阶段，浏览器会遇到特殊类型的 HTML 元素——脚本元素，该元素用于包括 JavaScript 代码。每当解析到脚本元素时，浏览器就
会停止从 HTML 构建 DOM，并开始执行 JavaScript 代码。

### 执行 JavaScript 代码

所有包含在脚本元素中的 JavaScript 代码由浏览器的 JavaScript 引擎执行，例如，Firefox 的 Spidermonkey 引擎，Chrome 和 Opera 的 V8 引擎和 Edge 的（IE 的）Chakra 引擎。由于代码的主要目的是提供动态页面，故而浏览器通过全局对象提供了一个 API 使 JavaScript 引擎可以与之交互并改变页面内容。

JavaScript 代码大致可以分成：全局代码和函数代码。

全局代码由 JavaScript 引擎（后续会做更多解释）以一种直接的方式自动执行，每当遇到这样的代码就一行接一行地执行。

若想执行函数代码，则必须被其他代码调用：既可以是全局代码（例如，由于全局代码的执行过程中执行了 addMessage 函数代
码，所以 addMessage 函数被调用），也可以是其他函数，还可以由浏览器调用（后续会做更多解释）。

当浏览器在页面构建阶段遇到了脚本节点，它会停止 HTML 到 DOM 的构建，转而开始执行 JavaScript 代码，也就是执行包含在脚本元素的全
局 JavaScript 代码

一旦 JavaScript 引擎执行到了脚本元素中 JavaScript 代码的最后一行，浏览器就退出了 JavaScript 执行模式，并继续余下的 HTML 构建为 DOM 节点。在这期间，如果浏览器再次遇到脚本元素，那么从 HTML 到 DOM 的构建再次暂停，JavaScript 运行环境开始执行余下的 JavaScript 代码。

<Alert>
JavaScript 应用在此时依然会保持着全局状态。所有在某个 JavaScript 代码执行期间用户创建的全局变量都能正常地被其他脚本元素中的 JavaScript 代码所访问到。其原因在于全局 window 对象会存在于整个页面的生存期之间，在它上面存储着所有的 JavaScript 变量。
</Alert>

## 事件处理

客户端 Web 应用是一种 GUI 应用，也就是说这种应用会对不同类型的事件作响应，如鼠标移动、单击和键盘按压等。因此，在页面构建阶
段执行的 JavaScript 代码，除了会影响全局应用状态和修改 DOM 外，还会注册事件监听器（或处理器）。这类监听器会在事件发生时，由浏览
器调用执行。有了这些事件处理器，我们的应用也就有了交互能力。

浏览器执行环境的核心思想基于：同一时刻只能执行一个代码片段，即所谓的单线程执行模型。当一个事件抵达后，浏览器需要执行相应的事件处理函数。这里不保证用户总会极富耐心地等待很长时间，直到下一个事件触发。所以，浏览器需要一种方式来跟踪已经发生但尚未处理的事件。为实现这个目标，浏览器使用了事件队列

## 总结

浏览器接收的 HTML 代码用作创建 DOM 的蓝图，它是客户端 Web 应用结构的内部展示阶段。
我们使用 JavaScript 代码来动态地修改 DOM 以便给 Web 应用带来动态行为。

客户端 Web 应用的执行分为两个阶段。
页面构建代码是用于创建 DOM 的，而全局 JavaScript 代码
是遇到 script 节点时执行的。在这个执行过程中，JavaScript 代
码能够以任意程度改变当前的 DOM，还能够注册事件处理器
——
事件处理器是一种函数，当某个特定事件（例如，一次鼠
标单击或键盘按压）发生后会被执行。注册事件处理器很容
易：使用内置的 addEventListener 方法。
事件处理——在同一时刻，只能处理多个不同事件中的一
个，处理顺序是事件生成的顺序。事件处理阶段大量依赖事件
队列，所有的事件都以其出现的顺序存储在事件队列中。事件
循环会检查事件队列的队头，如果检测到了一个事件，那么相
应的事件处理器就会被调用。

```

```
